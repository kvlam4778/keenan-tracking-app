<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keenan's Eats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Add SDKs for Firebase products that you want to use
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, deleteDoc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO_PROJECT" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-food-tracker';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        let userId = null;
        let foodEntriesCollectionRef = null;
        let checkinCollectionRef = null;
        let currentEntries = [];
        let currentCheckins = new Map();
        let selectedImageBase64 = null;

        // --- EMOJI MAPPINGS ---
        const moodEmojis = ["", "😠", "😟", "😐", "🙂", "😊", "😄", "😁", "🥰", "🤩", "🥳"];
        const itchinessEmojis = ["", "🙂", "🤔", "😐", "😒", "😟", "😫", "😖", "�", "😭", "🌋"];
        const appearanceEmojis = ["", "🤢", "😟", "😐", "🙂", "😊", "✨", "🤩", "💖", "👑", "🦄"];
        const emojiMaps = {
            mood: moodEmojis,
            itchiness: itchinessEmojis,
            appearance: appearanceEmojis
        };

        // DOM Elements
        const foodForm = document.getElementById('foodForm');
        const mealTypeInput = document.getElementById('mealType');
        const dateInput = document.getElementById('date');
        const foodLogContainer = document.getElementById('foodLogContainer');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const authLoadingIndicator = document.getElementById('authLoadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const closeMessageModalButton = document.getElementById('closeMessageModal');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const proteinInput = document.getElementById('protein');
        const vegetableInput = document.getElementById('vegetable');
        const dairyInput = document.getElementById('dairy');
        const fruitInput = document.getElementById('fruit');
        const carbsInput = document.getElementById('carbs');
        const otherInput = document.getElementById('other');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const geminiLoadingIndicator = document.getElementById('geminiLoadingIndicator');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        
        // Check-in UI Elements
        const moodSlider = document.getElementById('moodSlider');
        const itchinessSlider = document.getElementById('itchinessSlider');
        const appearanceSlider = document.getElementById('appearanceSlider');
        const saveCheckinButton = document.getElementById('saveCheckinButton');

        // --- Authentication ---
        async function setupAuth() {
            authLoadingIndicator.classList.remove('hidden');
            mainContent.classList.add('hidden');
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `Keenan's User ID: ${userId.substring(0,8)}...`;
                    foodEntriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/keenansFoodEntries`);
                    checkinCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/keenansDailyCheckin`);
                    loadAllData();
                    authLoadingIndicator.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error during sign-in:", error);
                        showMessage(`Error signing in: ${error.message}. Please refresh.`);
                        authLoadingIndicator.textContent = "Authentication failed. Please refresh.";
                    }
                }
            });
            if (!auth.currentUser) {
                 try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch (error) {
                    console.error("Initial sign-in attempt failed:", error);
                    showMessage(`Initial sign-in error: ${error.message}. Data might not save.`);
                }
            }
        }

        // --- Gemini Image Analysis ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                imagePreview.src = reader.result;
                selectedImageBase64 = reader.result.split(',')[1];
                imagePreviewContainer.classList.remove('hidden');
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImageWithGemini() {
            if (!selectedImageBase64) { showMessage("Please select an image first."); return; }
            geminiLoadingIndicator.classList.remove('hidden');
            analyzeButton.disabled = true;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const prompt = `Analyze the image of this meal. Identify the food items and categorize them into the following JSON schema. If an item isn't a clear fit, place it in 'other'. If multiple items fit one category, list them as a comma-separated string. For example, 'Chicken, Fish' for protein. If a category is empty, return an empty string.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: selectedImageBase64 }}]}], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { protein: { "type": "STRING" }, vegetable: { "type": "STRING" }, dairy: { "type": "STRING" }, fruit: { "type": "STRING" }, carbs: { "type": "STRING" }, other: { "type": "STRING" }}, required: ["protein", "vegetable", "dairy", "fruit", "carbs", "other"] }}};
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.text(); throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`); }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    const foodData = JSON.parse(result.candidates[0].content.parts[0].text);
                    proteinInput.value = foodData.protein || '';
                    vegetableInput.value = foodData.vegetable || '';
                    dairyInput.value = foodData.dairy || '';
                    fruitInput.value = foodData.fruit || '';
                    carbsInput.value = foodData.carbs || '';
                    otherInput.value = foodData.other || '';
                    showMessage("Food analysis complete! Review �
